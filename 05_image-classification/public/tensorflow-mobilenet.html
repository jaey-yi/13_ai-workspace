<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 560px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      section {
        margin-bottom: 1.5rem;
      }
      h1 {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
      }
      input[type="file"] {
        margin-bottom: 8px;
      }
      #preview {
        max-height: 240px;
        margin: 8px 0;
        display: block;
      }
      button {
        padding: 8px 16px;
        cursor: pointer;
        margin-right: 8px;
      }
      .status {
        font-size: 0.9em;
        color: #666;
        margin-top: 4px;
      }
      #result {
        margin-top: 12px;
        padding: 8px;
        min-height: 2em;
      }
    </style>
  </head>
  <body>
    <section>
      <h1>이미지 분류 (MobileNet)</h1>
      <p>이미지를 선택한 뒤 [분류] 버튼을 누르세요.</p>

      <input type="file" id="fileInput" accept="image/*" />
      <img id="preview" alt="미리보기" style="display: none" />
      <br />
      <button id="btnClassify">분류</button>

      <div id="status" class="status"></div>
      <div id="result"></div>
    </section>

    <script type="module">
      // 브라우저에서 머신 러닝 수행을 위한 코어라이브러리(tensorflow)
      import "https://cdn.jsdelivr.net/npm/@tensorflow/tfjs";

      // 사전 학습된 이미지 분류 신경망 모델
      import * as mobilenet from "https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.1/+esm";

      const fileInput = document.getElementById("fileInput");
      const preview = document.getElementById("preview");
      const statusEl = document.getElementById("status");
      const resultEl = document.getElementById("result");
      const btnClassify = document.getElementById("btnClassify");

      // 1. 미리보기
      fileInput.addEventListener("change", (e) => {
        // 업로드된 이미지파일의 정보 저장
        const file = e.target.files?.[0];
        if (!file) return;

        const reader = new FileReader(); //파일 읽기를 위해 FileReader ㅅ ㅐㅇ성
        reader.onload = (event) => {
          //파일 읽기가 완료됐을 때 실행되는 이벤트
          // evetn.target.result
          preview.src = event.target.result ?? "";
          preview.style.display = "block"; //?? 이건 뭐냐 >==> display: 'none' - 안보임 / 'block' - 블럭요소ㅡ 한줄 전체 차지 / 'inline' - 인라인 요소 - 텍스트처럼 넣기
          resultEl.textContent = "";
        };

        // 이미지를 reader 읽어들이기
        reader.readAsDataURL(file); // 읽어드림 이벤트 발생 => 자동으로 reader.onload 실행됨
      });

      // 2. 분류하기
      // TensorFlow / MobileNet 모델 객체
      let mobilenetModel = null;

      // 모델 로드 함수 (최초호출? 로드+ qksghks / 그 이후, 즉시 반환)
      async function getMobilenetModel() {
        if (mobilenetModel) return mobilenetModel;
        statusEl.textContent = "모델 로드 중 ...";
        // 모델 로드
        mobilenetModel = await mobilenet.load();
        statusEl.textContent = "";
        return mobilenetModel;
      }

      async function classify() {
        if (!preview.src) {
          resultEl.textContent = "이미지를 먼저 선택해주세요";
          return;
        } // 이미지 없을때;

        try {
          // 모델 가져오기

          const model = await getMobilenetModel();
          // 모델 가지고 분류(추론, 실행) 하기 => Model.classify(ImageElement, topk(3), )

          const predictions = await model.classify(preview, 5);
          console.log(predictions);
          resultEl.innerHTML = predictions
            .map(
              (p) => ` ${p.className} : ${(p.probability * 100).toFixed(1)}%`,
            )
            .join("<br/>");
        } catch (error) {
          resultEl.textContent = "오류:" + error.message;
        }
      }
      btnClassify.addEventListener("click", classify);
    </script>
  </body>
</html>
